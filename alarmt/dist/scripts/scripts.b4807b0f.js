"use strict";angular.module("alarmt",["ngRoute","ngTouch","alarmt.accountsView","alarmt.mainView","alarmt.eventLogView","alarmt.monitorView","alarmt.pinCodeView","alarmt.loginView","alarmt.wouldTriggerView","alarmt.triggeredItemsView","aserviceModule","storeModule"]).config(["$routeProvider",function(a){a.otherwise({redirectTo:"/main"})}]).directive("watchSize",["$parse","$window","$rootScope",function(a,b,c){return function(d,e,f){var g=a(f.watchSize);if(!angular.isDefined(c.watchSize)){var h=angular.element(b);c.watchSize={},d.$watch(function(){return{width:h.width(),fullWidth:h.width(),height:h.height(),fullHeight:h.height()}},function(a){c.watchSize.window=a},!0),h.bind("resize",function(){d.$apply()})}d.$watch(function(){return{width:e.width(),fullWidth:e.outerWidth(!0),height:e.height(),fullHeight:e.outerHeight(!0)}},function(a){g.assign(c.watchSize,a)},!0)}}]).factory("appInfo",["$log","$window",function(a,b){function c(c){for(var d=b.location.search.substring(1),e=d.split("&"),f=0;f<e.length;f++){var g=e[f].split("=");if(decodeURIComponent(g[0])==c)return decodeURIComponent(g[1])}return void a.debug("Query variable %s not found",c)}var d,e={};"undefined"!=typeof HomeKiosk?(e.kiosk={origUrl:HomeKiosk.getOrigUrl(),playSound:function(a){HomeKiosk.playSound(a)},stopSound:function(a){HomeKiosk.stopSound(a)}},d=e.kiosk.origUrl):d=b.location.href;var f=d.substr(b.location.protocol.length+2);if(f=f.substr(0,f.indexOf("/")),f.indexOf("@")>=0){var g=f.substr(0,f.indexOf("@")).split(":");e.userName=g[0],e.password=g[1]}else{var h=c("userName");if(angular.isDefined(h)){e.userName=h,e.password=c("password");var i=c("serverAddress");angular.isDefined(i)&&0!==i.indexOf("http:")&&0!==i.indexOf("https:")&&(i=b.location.protocol+"//"+i,e.serverAddress=i)}}return e.baseUrl=b.location.origin,e.baseUrl.indexOf("?")>=0&&(e.baseUrl=e.baseUrl.substr(0,e.baseUrl.indexOf("?"))),angular.isDefined(e.serverAddress)||(e.serverAddress=e.baseUrl),a.debug("starting: absUrl: "+d),a.debug("starting: baseUrl: "+e.baseUrl),angular.isDefined(e.userName)&&a.debug("starting: userName: "+e.userName),e}]).controller("AppCtrl",["$log","$rootScope","aservice","$scope","$route","$http","$timeout","$interval","$location","wouldTriggerDialog","accountsDialog","ASERVICE_EVENTS","appInfo","store",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){d.accounts=n.accounts;var o=function(){if(d.accountId=angular.isDefined(c.session)?c.session.account.id:void 0,d.accountName=angular.isDefined(c.session)?c.session.account.name:void 0,d.hasSession=angular.isDefined(c.session),d.armedState=angular.isDefined(c.session)?c.session.events.armedStates.active:null,d.sirenState=angular.isDefined(c.session)?c.session.events.sirenState:null,angular.isDefined(m.kiosk)){var a=null;if(null!==d.armedState&&d.armedState.armingTimeLeft>0&&null!==d.armedState.metadata){var b=d.armedState.metadata.armingSound;null!==b&&(a=m.baseUrl+b)}d.activeSound!=a&&(null!==a?m.kiosk.playSound(a):m.kiosk.stopSound(d.activeSound),d.activeSound=a)}};if(d.formatAccountPath=function(a,b){return"/account/"+a+"/"+b},d.formatPath=function(a){return angular.isDefined(d.accountId)?d.formatAccountPath(d.accountId,a):""},d.setActiveView=function(a){angular.isDefined(d.accountId)&&i.path(d.formatPath(a))},d.isActive=function(a){return i.path()===d.formatPath(a)},d.activeSound=null,d.wouldTriggerDialogPromise=null,d.$on(l.modified,o),d.$on(l.newSession,o),o(),d.$watch("armedState.wouldTriggerItems",function(){null===d.wouldTriggerDialogPromise&&null!==d.armedState&&d.armedState.armingTimeLeft>0&&Object.keys(d.armedState.wouldTriggerItems).length>0&&(d.wouldTriggerDialogPromise=j(c.session),d.wouldTriggerDialogPromise.result.then(function(){d.wouldTriggerDialogPromise=null},function(){d.wouldTriggerDialogPromise=null}))}),d.$watch("sirenState.active",function(a,b){angular.isDefined(b)&&d.sirenState.active===!0&&d.setActiveView("main")}),d.$watch("armedState.name",function(a,b){angular.isDefined(b)&&d.setActiveView("main")}),d.activateWouldTrigger=function(){j().result.then(function(a){},function(){})},d.currentAccount=function(){return angular.isDefined(d.accountName)?d.accountName:"???"},d.isKiosk=angular.isDefined(m.kiosk),d.showSidebar=!angular.isDefined(m.kiosk)&&!angular.isDefined(m.userName),d.sidebar=!1,d.activateSidebar=function(){d.sidebar=!0},d.isConnected=function(){return c.isConnected()},d.manageAccounts=function(){d.sidebar=!1,k()},d.connectAccount=function(a){d.sidebar=!1,i.path(d.formatAccountPath(a,"main"))},0===d.accounts.size())k();else if(!angular.isDefined(d.accountId)&&!angular.isDefined(c.pendingAccountId())){var p=n.accounts.lastAccountId;if(angular.isDefined(p)&&p in n.accounts.items)d.connectAccount(p);else{var q;for(var r in n.accounts.items)(!angular.isDefined(q)||q>r)&&(q=r);d.connectAccount(q)}}a.info("Starting App Controller Poller")}]);var aserviceModule=angular.module("aserviceModule",["storeModule"]);aserviceModule.constant("ASERVICE_EVENTS",{newSession:"aservice-new-session",modified:"aservice-modified",initialized:"aservice-initialized"}).factory("aservice",["$http","$timeout","$log","$q","$rootScope","$window","ASERVICE_EVENTS","store",function(a,b,c,d,e,f,g,h){var i=1e4,j=30,k=60,l=function(){var a;this.history=[],this.update=function(b,c){if(this.history.splice(0,this.history.length-j),b){if(this.history.length>0&&(a=this.history[this.history.length-1],a[1]+1>=c))return void(a[1]=Number.MAX_VALUE);this.history.push([c,Number.MAX_VALUE])}else{if(0===this.history.length)return;a=this.history[this.history.length-1],a[1]==Number.MAX_VALUE&&(a[1]=c)}},this.isDetected=function(a){for(var b,c,d=0,e=this.history.length-1;e>=d;)if(b=(d+e)/2|0,c=this.history[b],c[1]<a)d=b+1;else{if(!(c[0]>a))return!0;e=b-1}return!1},this.isRecentlyDetected=function(a,b){return 0===this.history.length?!1:this.history[this.history.length-1][1]>=a-b}},m=function(d,h){var j=this,k=d.account.serverAddress+"/events";this.now=null,this.initialized=!1,this.eventsSyncPoint=null,this.objects={},this.sortedObjects=[],this.eventsTimer=null,this.armedStatesEvent=null,this.armedStates={activeId:null,active:null,states:{}},this.eventLog=null,this.detectedSensors={};var m={connection:void 0,opened:!1,enabled:-1};this.processEvent=function(a){var b=JSON.parse(a);angular.isDefined(b.name)||(b.name=b.id);var c=null;if(b.lowerName=b.name.toLowerCase(),b.id in this.objects&&(c=this.objects[b.id]),this.objects[b.id]=b,"NOP"==b.type)this.eventsSyncPoint=b.syncValue;else if("Sensor"===b.type||"UserSession"===b.type)b.detectionHistory=null!==c?c.detectionHistory:new l,b.detectionHistory.update(b.detected===!0,this.now),b.detected===!0?this.detectedSensors[b.id]={name:b.name,timestamp:this.now}:delete this.detectedSensors[b.id];else if("Group"===b.type||"User"===b.type)b.detectionHistory=null!==c?c.detectionHistory:new l,b.detectionHistory.update(b.detected.length>0,this.now);else if("ArmedStates"==b.type)this.armedStatesEvent=b,this.armedStates.activeId=b.active;else if("ArmedState"==b.type){this.armedStates.states[b.id]=b;for(var d in b.bypassedItems)d in b.wouldTriggerItems&&delete b.wouldTriggerItems[d],d in b.triggeredItems&&delete b.triggeredItems[d]}else"SirenState"==b.type?this.sirenState=b:"EventLog"==b.type&&(this.eventLog=b)},this.cancelTimer=function(){null!==this.eventsTimer&&(b.cancel(this.eventsTimer),this.eventsTimer=null)},this.rescheduleEvents=function(a){this.cancelTimer();var c=this;this.eventsTimer=b(function(){c.processEvents()},a)},this.processChunk=function(a,b){null===j.eventsSyncPoint&&(j.objects={},j.sortedObjects=[]);try{j.now=Math.floor((new Date).getTime()/1e3);for(var f=a.split("\n"),h=0;h<f.length;h++)try{f[h].length>0&&j.processEvent(f[h])}catch(i){c.error("processEvent("+f[h]+") failed. error:"+i)}}catch(i){c.error("processEvent failed. error:"+i)}if(j.armedStates.active=j.armedStates.states[j.armedStates.activeId],j.sortedObjects.length!=Object.keys(j.objects).length){for(var k in j.objects){var l=j.objects[k];j.sortedObjects.push({lowerName:l.lowerName,id:l.id})}j.sortedObjects.sort(function(a,b){return a.lowerName.localeCompare(b.lowerName)})}angular.isDefined(j.eventsSyncPoint)&&null!==j.eventsSyncPoint&&(j.initialized||(e.$broadcast(g.initialized,d),j.initialized=!0),e.$broadcast(g.modified,d)),b&&j.rescheduleEvents(0)},this.processHttpEvents=function(){var b=k+"?maxSize=1";null!==this.eventsSyncPoint&&(b+="&since="+this.eventsSyncPoint);var e;e=a({url:b,method:"GET",headers:{Authorization:"Basic "+btoa(d.account.userName+":"+d.account.password)},timeout:angular.isObject(h)?h.promise:void 0,transformResponse:function(a){return a}}),e.success(function(a){j.processChunk(a,!0)}),e.error(function(a,d,e,f){c.debug("get events failed. url:"+b+". error:"+d),j.eventsSyncPoint=null,j.rescheduleEvents(i)})},this.processWebSocketEvents=function(){var a;if("http:"==k.substr(0,5))a="ws:"+k.substr(5);else{if("https:"!=k.substr(0,6))throw c.error("unknown eventsUrl"),"unknown eventsUrl";a="wss:"+k.substr(6)}var g=a+"?maxSize=-1";g=g+"&authorization="+encodeURIComponent("Basic "+btoa(d.account.userName+":"+d.account.password)),c.debug("connecting to websocket. url:"+g),m.connection=new f.WebSocket(g,["events"]),c.debug("websocket object created");var l;-1==m.enabled&&(l=b(function(){c.debug("websocket: fail back to http long-polling"),m.connection=void 0,m.enabled=0,j.processHttpEvents()},3e3));var n=function(){angular.isDefined(l)&&(b.cancel(l),l=void 0)};m.connection.onopen=function(){e.$apply(function(){c.debug("websocket connection opened"),m.opened=!0})},m.connection.onerror=function(a){e.$apply(function(){c.debug("websocket connect failed"),n();try{m.connection.close()}catch(a){}m.connection=void 0,j.rescheduleEvents(i)})},m.connection.onmessage=function(a){m.enabled=1,e.$apply(function(){n(),j.processChunk(a.data,!1)})},m.connection.onclose=function(){c.debug("websocket connect closed"),n(),m.connection=void 0,j.rescheduleEvents(i)},h.promise.then(function(){e.$apply(function(){if(angular.isDefined(m.connection)){try{m.connection.close()}catch(a){}m.connection=void 0}})})},this.processEvents=function(){0!=m.enabled&&(angular.isDefined(f.WebSocket)||(c.debug("websocket is not available"),m.enabled=0)),0!=m.enabled?(angular.isDefined(m.connection)&&c.error("invalid state. prev websocket connection is still open"),this.processWebSocketEvents()):this.processHttpEvents()},this.processEvents()},n=function(b){var c=this;this.account=b;var e=d.defer();this.events=new m(c,e);var f=function(){},g={value:null,time:0},h=function(b,f,h){var i=d.defer(),j={url:b,method:"POST",data:f,timeout:angular.isObject(e)?e.promise:void 0,headers:{Authorization:"Basic "+btoa(c.account.userName+":"+c.account.password)},transformResponse:function(a){return a}},l=Math.floor((new Date).getTime()/1e3),m=h;return!angular.isDefined(m)&&null!==g.value&&l-g.time<=k&&(m=g.value),null!==m&&(j.headers["x-pincode"]=m),a(j).success(function(a){null!==m&&(g.value=m,g.time=l),i.resolve()}).error(function(a,b,c,d){i.reject(b)}),i.promise},i=function(b){var d={url:b,method:"GET",timeout:angular.isObject(e)?e.promise:void 0,headers:{Authorization:"Basic "+btoa(c.account.userName+":"+c.account.password)},transformResponse:function(a){return a}};return a(d)};this.arm=function(a,c){return f(),h(b.serverAddress+"/armed_state",a,c)},this.bypassSensor=function(a,c){return f(),h(b.serverAddress+"/bypass_sensor",a,c)},this.getEventLog=function(){f();var a=i(b.serverAddress+"/event_log"),c=d.defer();return a.success(function(a){c.resolve(a)}).error(function(a){c.reject(a)}),c.promise},this.getSensorHistory=function(a){f();var c=i(b.serverAddress+"/sensor_history.json?item="+a),e=d.defer();return c.success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise},this.isConnected=function(){return f(),null===this.events?!1:null!==this.events.eventsSyncPoint},this.cancelArming=function(a){return f(),h(b.serverAddress+"/cancel_arming","",a)}},o={timeout:null,accountId:void 0},p={session:void 0,isConnected:function(){return angular.isDefined(this.session)&&this.session.isConnected()},isAccount:function(a){return angular.isDefined(this.session)&&this.session.account.id===a},pendingAccountId:function(){return o.accountId},createSession:function(f){null!==o.timeout&&(o.timeout.resolve("rejecting due to a new session"),o.timeout=null,o.accountId=void 0),angular.isDefined(this.session)&&(delete this.session,this.session=void 0);var i=h.accounts.items[f];if(!angular.isDefined(i))throw"no such account";h.accounts.updateLastAccountId(f);var j=d.defer(),k=d.defer();return o.timeout=k,o.accountId=f,a.get(i.serverAddress+"/login",{headers:{Authorization:"Basic "+btoa(i.userName+":"+i.password)},timeout:k.promise}).success(function(){c.info("login completed successfully"),o.timeout=null,o.accountId=void 0;var a=new n(i);e.$on(g.initialized,function(c,d){a==d&&b(function(){p.session=a,e.$broadcast(g.newSession,a),j.resolve(p.session)},0)})}).error(function(a){j.reject(a)}),j.promise},ensureSession:function(a){if(this.isAccount(a))return this.session;var b=d.defer(),c=this.createSession(a);return c.then(function(a){b.resolve(a)}),b.promise}};return p}]).factory("aserviceSession",["$q","$rootScope","aservice","ASERVICE_EVENTS",function(a,b,c,d){if(angular.isDefined(c.session))return c.session;var e=a.defer();return b.$on(d.newSession,function(){e.resolve(c.session)}),e.promise}]);var PushNotification=function(){};PushNotification.prototype.register=function(a,b,c){return null===b&&(b=function(){}),"function"!=typeof b?void console.log("PushNotification.register failure: failure parameter not a function"):"function"!=typeof a?void console.log("PushNotification.register failure: success callback parameter must be a function"):void cordova.exec(a,b,"PushPlugin","register",[c])},PushNotification.prototype.unregister=function(a,b){return null===b&&(b=function(){}),"function"!=typeof b?void console.log("PushNotification.unregister failure: failure parameter not a function"):"function"!=typeof a?void console.log("PushNotification.unregister failure: success callback parameter must be a function"):void cordova.exec(a,b,"PushPlugin","unregister",[])},PushNotification.prototype.setApplicationIconBadgeNumber=function(a,b,c){return null===b&&(b=function(){}),"function"!=typeof b?void console.log("PushNotification.setApplicationIconBadgeNumber failure: failure parameter not a function"):"function"!=typeof a?void console.log("PushNotification.setApplicationIconBadgeNumber failure: success callback parameter must be a function"):void cordova.exec(a,b,"PushPlugin","setApplicationIconBadgeNumber",[{badge:c}])},window.plugins||(window.plugins={}),window.plugins.pushNotification||(window.plugins.pushNotification=new PushNotification);var storeModule=angular.module("storeModule",[]);storeModule.constant("STORE_EVENTS",{modified:"store-modified"}).factory("store",["$log","$q","$window","appInfo","STORE_EVENTS",function(a,b,c,d,e){var f=function(a,b,c,d){this.name=a,this.serverAddress=b,this.userName=c,this.password=d},g=function(){this.items={},this.size=function(){return Object.keys(this.items).length},this.add=function(a){if(!angular.isDefined(a.id)||null===a.id)for(var b=0;1e4>b;++b)if(!(b in this.items)){a.id=""+b;break}if(a.id in this.items)throw"account already exists";this.items[a.id]=a,this.store()},this.update=function(a,b){b.id=a,this.items[a]=b,this.store()},this.remove=function(a){angular.isObject(a)?delete this.items[a.id]:delete this.items[""+a],this.store()},this.updateLastAccountId=function(a){this.lastAccountId=a,this.store()},this.load=function(){if(angular.isDefined(d.userName))this.items={0:{name:"Home",serverAddress:d.serverAddress,userName:d.userName,password:d.password,id:"0"}},this.lastAccountId=0;else{var a=c.localStorage.getItem("AlarmT_accounts");if(angular.isDefined(a)){var b=JSON.parse(a);angular.isDefined(b)&&angular.isObject(b)&&(this.items=b)}this.lastAccountId=c.localStorage.getItem("AlarmT_lastAccountId")}},this.store=function(){if(angular.isDefined(d.userName))return void a.error("accounts cannot be stored when used as url");var b=JSON.stringify(this.items);c.localStorage.setItem("AlarmT_accounts",b),angular.isDefined(this.lastAccountId)&&c.localStorage.setItem("AlarmT_lastAccountId",this.lastAccountId)},this.lastAccountId=void 0,this.load()},h={Account:f,accounts:new g};return h}]),angular.module("alarmt.mainView",["ngRoute"]).config(["$routeProvider",function(a){a.when("/account/:account/main",{templateUrl:"views/main/main.html",controller:"MainCtrl",resolve:{asession:["$route","$location","aservice","store",function(a,b,c,d){return a.current.params.account in d.accounts.items?c.ensureSession(a.current.params.account):void 0}]}})}]).controller("MainCtrl",["$scope","$log","pinCodeDialog","ASERVICE_EVENTS","$rootScope","asession","triggeredItemsDialog",function(a,b,c,d,e,f,g){var h=function(){a.armedStates=[];for(var b in f.events.armedStates.states)a.armedStates.push(f.events.armedStates.states[b]);a.armedState=f.events.armedStates.active,a.$watch(function(){return angular.isDefined(e.watchSize.view)&&angular.isArray(a.armedStates)&&a.armedStates.length>0?e.watchSize.view.fullHeight/a.armedStates.length:30},function(b){a.buttonHeight=b})};a.triggeredItemsDialogPromise=null,a.triggeredItemsCount=function(b){return null!=a.armedState&&b===a.armedState.id?Object.keys(a.armedState.triggeredItems).length:0},a.$on(d.modified,h),h(),a.arm=function(d,e){return d===a.armedState.id?void(a.triggeredItemsCount(d)>0&&null==a.triggeredItemsDialogPromise&&(a.triggeredItemsDialogPromise=g(f),a.triggeredItemsDialogPromise.result.then(function(){a.triggeredItemsDialogPromise=null},function(){a.triggeredItemsDialogPromise=null}))):void f.arm(d,e).then(function(){b.info("arming completed")},function(b){return 403==b?void c().result.then(function(b){a.arm(d,b)}):void 0})}}]),angular.module("alarmt.eventLogView",["ngRoute"]).config(["$routeProvider",function(a){a.when("/account/:account/eventLog",{templateUrl:"views/eventLog/eventLog.html",controller:"EventLogCtrl",resolve:{asession:["$route","$location","aservice","store",function(a,b,c,d){return a.current.params.account in d.accounts.items?c.ensureSession(a.current.params.account):void 0}]}})}]).controller("EventLogCtrl",["asession","$timeout","$scope","$log","pinCodeDialog","ASERVICE_EVENTS",function(a,b,c,d,e,f){c.severities=["INFO","NOTICE","WARNING","ALERT"],c.eventLogPromise=void 0,c.eventLogModified=void 0,c.newEventLogModifiedCount=void 0,c.loadingEventLogModified=void 0,c.loading=!0;var g=function(){angular.isDefined(c.eventLogPromise)||(c.loading=!0,c.loadingEventLogModified=c.newEventLogModifiedCount,c.eventLogPromise=a.getEventLog(),c.eventLogPromise.then(function(a){c.eventLogPromise=void 0,c.eventLogModified=c.loadingEventLogModified,c.loadingEventLogModified!==c.newEventLogModifiedCount&&g(),c.eventLog=JSON.parse(a),c.loading=!1},function(){c.eventLogPromise=void 0,c.loading=!1,b(function(){g()},5e3)}))},h=function(){c.armedState=a.events.armedState,null!=a.events.eventLog&&(c.newEventLogModifiedCount=a.events.eventLog.modified),c.loadingEventLogModified!==c.newEventLogModifiedCount&&g()};c.$on(f.modified,h),c.formatMessage=function(a){return"armed"===a.message?a.data.id:a.message},h()}]),angular.module("alarmt.accountsView",["ngRoute","alarmt.editAccountView","alarmt.inputBoxView","storeModule"]).factory("accountsDialog",["$log","$modal",function(a,b){return function(){var a=b.open({templateUrl:"views/accounts/accounts.html",controller:"AccountsCtrl",windowClass:"accounts-dialog full-screen",size:"lg",resolve:{}});return a}}]).controller("AccountsCtrl",["$scope","$log","pinCodeDialog","store","editAccountDialog","inputBoxDialog",function(a,b,c,d,e,f){a.accounts=d.accounts,a.editingAccounts=!1,a.markedAccounts={},a.markedCount=function(){return Object.keys(a.markedAccounts).length},a.toggleEdit=function(){a.markedAccounts={},a.editingAccounts=!a.editingAccounts},a.deleteMarked=function(){0!=a.markedCount()&&f({title:"Confirm Delete Accounts",message:"You are about to delete accounts. Are you sure?",buttons:[{id:"yes",text:"Yes"},{id:"no",text:"No"}],footerClass:"sm-col-6"}).result.then(function(b){if("yes"===b){for(var c in a.markedAccounts)a.accounts.remove(c);a.markedAccounts={},a.editingAccounts=!1}})},a.editAccount=function(b){a.editingAccounts?b in a.markedAccounts?delete a.markedAccounts[b]:a.markedAccounts[b]=!0:e(a.accounts.items[b]).result.then(function(c){a.accounts.update(b,c)})},a.addAccount=function(){e(null,0==a.accounts.size()).result.then(function(b){a.accounts.add(b)})},0==a.accounts.size()&&a.addAccount()}]),angular.module("alarmt.editAccountView",["ui.bootstrap"]).factory("editAccountDialog",["$log","$modal",function(a,b){return function(a,c){var d=b.open({templateUrl:"views/editAccount/editAccount.html",controller:"EditAccountCtrl",backdrop:!1,keyboard:!1,windowClass:"editAccountDialog full-screen",size:"lg",resolve:{account:function(){return a},force:function(){return c}}});return d}}]).directive("serverAddressValidator",["$http","$q",function(a,b){return{require:"ngModel",link:function(c,d,e,f){f.$asyncValidators.serverAddressValidator=function(d,e){var f=c,g=b.defer();return a.get(e+"/").success(function(a,b){"OK\n"===a?(console.log("serverAddressValidator succeeded"),f.editAccountForm.userName.$validate(),f.editAccountForm.password.$validate(),g.resolve()):(console.log("serverAddressValidator failed: response:"+a),g.reject())}).error(function(a,b){console.log("serverAddressValidator failed: "+b),g.reject()}),g.promise}}}}]).directive("loginValidator",["$http","$q",function(a,b){return{require:"ngModel",link:function(c,d,e,f){f.$asyncValidators.loginValidator=function(d,e){var f=c,g=b.defer();return a.get(f.editAccountForm.serverAddress.$viewValue+"/login",{headers:{Authorization:"Basic "+btoa(f.editAccountForm.userName.$viewValue+":"+f.editAccountForm.password.$viewValue)},timeout:2e3}).success(function(){console.log("loginValidator succeeded"),f.editAccountForm.userName.$setValidity("loginValidator",!0),f.editAccountForm.password.$setValidity("loginValidator",!0),g.resolve()}).error(function(a,b){console.log("loginValidator failed: "+b),g.reject()}),g.promise}}}}]).directive("uniqueAccountValidator",["$http","$q","store",function(a,b,c){return{require:"ngModel",link:function(a,b,d,e){e.$validators.uniqueAccountValidator=function(b,d){var e=!0;return angular.forEach(c.accounts.items,function(b,c){b.name===d&&c!=a.accountId&&(e=!1)}),e}}}}]).controller("EditAccountCtrl",["$scope","$modalInstance","$timeout","$window","store","account","force",function(a,b,c,d,e,f,g){a.force=g,null==f?a.accountId=-1:(a.accountId=f.id,a.accountName=f.name,a.serverAddress=f.serverAddress,a.userName=f.userName,a.password=f.password),a.addUpdateAccount=function(){if(a.editAccountForm.$valid){var b=new e.Account(a.accountName,a.serverAddress,a.userName,a.password);a.$close(b)}}}]),angular.module("alarmt.monitorView",["alarmt.sensorHistoryView","ngRoute"]).config(["$routeProvider",function(a){a.when("/account/:account/monitor",{templateUrl:"views/monitor/monitor.html",controller:"MonitorCtrl",resolve:{asession:["$route","$location","aservice","store",function(a,b,c,d){return a.current.params.account in d.accounts.items?c.ensureSession(a.current.params.account):void 0}]}})}]).controller("MonitorCtrl",["asession","$scope","$rootScope","$log","$interval","sensorHistoryDialog","ASERVICE_EVENTS",function(a,b,c,d,e,f,g){angular.isDefined(c.monitorFilterExpression)||(c.monitorFilterExpression={name:null,sensors:!0,users:!1,groups:!0,detected:!1}),b.now=Math.floor((new Date).getTime()/1e3),b.monitorTimer=null,b.maxHistory=10;var h=function(){var d=((new Date).getTime(),b.maxHistory),e=c.monitorFilterExpression;b.filteredObjects=[];var f=b.now,g=e.name;if(null!==g&&""!==g&&(g=g.toLowerCase()),null!=a.events)for(var h=a.events.sortedObjects,i=0;i<h.length;++i){var j=h[i],k=a.events.objects[j.id];if(!(null!=g&&""!==g&&j.lowerName.indexOf(g)<0)){if("User"===k.type||"UserSession"===k.type||"users"===k.id){if(!e.users)continue}else if("Sensor"===k.type){if(!e.sensors)continue;if(e.recentlyDetected&&!k.detectionHistory.isRecentlyDetected(f,d))continue}else{if("Group"!==k.type)continue;if(!e.groups)continue;if(e.recentlyDetected&&!k.detectionHistory.isRecentlyDetected(f,d))continue}b.filteredObjects.push(k)}}(new Date).getTime()},i=function(){};b.$on(g.modified,i),i(),h(),b.cancelTimer=function(){null!=b.monitorTimer&&(e.cancel(b.monitorTimer),b.monitorTimer=null)},b.$on("$destroy",function(){b.cancelTimer()}),b.isDetected=function(a,c){var d=a.detectionHistory.isDetected(b.now-c);return d},b.isGroup=function(a){return"Group"===a.type},b.isUser=function(a){return"User"===a.type||"UserSession"===a.type},b.isSensor=function(a){return"Sensor"===a.type},b.sensorHistory=function(a){f(a.id)},b.monitorTimer=e(function(){b.now=Math.floor((new Date).getTime()/1e3),h()},500)}]),angular.module("alarmt.sensorHistoryView",["ui.bootstrap"]).factory("sensorHistoryDialog",["$log","$modal",function(a,b){return function(a){var c=b.open({templateUrl:"views/sensorHistory/sensorHistory.html",controller:"SensorHistoryCtrl",backdrop:!1,keyboard:!1,windowClass:"sensorHistoryDialog full-screen",size:"lg",resolve:{itemId:function(){return a},asession:["$route","$location","aservice","store",function(a,b,c,d){return a.current.params.account in d.accounts.items?c.ensureSession(a.current.params.account):void 0}]}});return c}}]).controller("SensorHistoryCtrl",["asession","$scope","$rootScope","$log","$timeout","$interval","ASERVICE_EVENTS","itemId",function(a,b,c,d,e,f,g,h){b.sensorHistoryPromise=void 0,b.sensorHistoryModified=void 0,b.newsensorHistoryModifiedCount=void 0,b.loadingsensorHistoryModified=void 0,b.loading=!0;var i=function(){angular.isDefined(b.sensorHistoryPromise)||(b.loading=!0,b.loadingSensorHistoryModified=b.newSensorHistoryModifiedCount,b.sensorHistoryPromise=a.getSensorHistory(h),b.sensorHistoryPromise.then(function(a){b.sensorHistoryPromise=void 0,b.sensorHistoryModified=b.loadingSensorHistoryModified,b.loadingSensorHistoryModified!==b.newSensorHistoryModifiedCount&&i();var c=JSON.parse(a);b.sensorHistory=[],angular.forEach(c,function(a,c){b.sensorHistory.push({time:parseInt(c),count:a})}),b.sensorHistory.sort(function(a,b){return b.time-a.time}),b.loading=!1},function(){b.sensorHistoryPromise=void 0,b.loading=!1,e(function(){i()},5e3)}))};i();var j=function(){};b.$on(g.modified,j),b.formatMessage=function(a){return"armed"===a.message?a.data.id:a.message},j()}]),angular.module("alarmt.pinCodeView",["ui.bootstrap"]).factory("pinCodeDialog",["$log","$modal",function(a,b){return function(){var a=b.open({templateUrl:"views/pinCode/pinCode.html",controller:"PinCodeCtrl",size:"sm",windowClass:"pinCodeDialog",resolve:{}});return a}}]).controller("PinCodeCtrl",["$scope","$modalInstance","$timeout",function(a,b,c){a.pin_code="",a.delPinCode=function(b){a.pin_code.length>0&&a.pin_code.length<4&&(a.pin_code=a.pin_code.substr(0,a.pin_code.length-1))},a.appendPinCode=function(d){return a.pin_code.length<4&&(a.pin_code+=d),4==a.pin_code.length?void c(function(){b.close(a.pin_code)}):void 0}}]),angular.module("alarmt.inputBoxView",["ui.bootstrap"]).factory("inputBoxDialog",["$log","$modal",function(a,b){return function(a){var c=b.open({templateUrl:"views/inputBox/inputBox.html",controller:"InputBoxCtrl",keyboard:!0,windowClass:"inputBoxDialog xs-full-screen "+(angular.isDefined(a.windowClass)?a.windowClass:""),size:angular.isDefined(a.size)?a.size:"lg",resolve:{cfg:function(){return a}}});return c}}]).controller("InputBoxCtrl",["$scope","$timeout","$window","cfg",function(a,b,c,d){a.cfg=d}]),angular.module("alarmt.loginView",["ui.bootstrap"]).factory("loginDialog",["$log","$modal",function(a,b){return function(){var a=b.open({templateUrl:"views/login/login.html",controller:"LoginCtrl",backdrop:!1,keyboard:!1,windowClass:"loginDialog full-screen",size:"lg",resolve:{}});return a}}]).controller("LoginCtrl",["$scope","$modalInstance","$timeout","$window",function(a,b,c,d){a.userName="",a.password="",a.rememberMe=!0,a.errorMessage="",a.$watch("userName",function(){a.errorMessage=""}),a.$watch("password",function(){a.errorMessage=""}),a.loginPromise=null,a.login=function(){a.errorMessage="",a.loginPromise.then(function(b){return a.loginPromise=null,null==b?(a.rememberMe&&"undefined"!=typeof Storage&&(d.localStorage.userName=a.userName,d.localStorage.password=a.password),void a.$dismiss()):void(a.errorMessage="Authentication failed")})}}]),angular.module("alarmt.wouldTriggerView",["ui.bootstrap"]).factory("wouldTriggerDialog",["$log","$modal",function(a,b){return function(a){var c=b.open({templateUrl:"views/wouldTrigger/wouldTrigger.html",controller:"WouldTriggerCtrl",windowClass:"would-trigger-dialog xs-full-screen",size:"sm",resolve:{asession:function(){return a}}});return c}}]).controller("WouldTriggerCtrl",["$scope","$log","$modalInstance","$timeout","asession","pinCodeDialog","ASERVICE_EVENTS",function(a,b,c,d,e,f,g){var h=function(){a.armedState=e.events.armedStates.states[e.events.armedStates.activeId]};a.$on(g.modified,h),h(),a.sensorName=function(a){return e.events.objects[a].name},a.bypassSensor=function(c,d){e.bypassSensor(c,d).then(function(){b.info("sensor "+c+" bypassed")},function(b){403==b&&f().result.then(function(b){a.bypassSensor(c,b)})})},a.cancelArming=function(c){e.cancelArming(c).then(function(){b.info("arming cancelled")},function(b){403==b&&f().result.then(function(b){a.cancelArming(b)})})},a.$watch("armedState.wouldTriggerItems",function(){null!=a.armedState&&0==Object.keys(a.armedState.wouldTriggerItems).length&&a.$dismiss()}),a.$watch("armedState.armingTimeLeft",function(){null!=a.armedState&&0==a.armedState.armingTimeLeft&&a.$dismiss()})}]),angular.module("alarmt.triggeredItemsView",["ui.bootstrap"]).factory("triggeredItemsDialog",["$log","$modal",function(a,b){return function(a){var c=b.open({templateUrl:"views/triggeredItems/triggeredItems.html",controller:"TriggeredItemsCtrl",windowClass:"triggered-items-dialog xs-full-screen",size:"lg",resolve:{asession:function(){return a}}});return c}}]).controller("TriggeredItemsCtrl",["$scope","$log","$modalInstance","$timeout","asession","pinCodeDialog","ASERVICE_EVENTS",function(a,b,c,d,e,f,g){var h=function(){a.armedState=e.events.armedStates.states[e.events.armedStates.activeId]};a.$on(g.modified,h),h(),a.sensorName=function(a){return e.events.objects[a].name},a.bypassSensor=function(c,d){e.bypassSensor(c,d).then(function(){b.info("sensor "+c+" bypassed")},function(b){return 403==b?void f().result.then(function(b){a.bypassSensor(c,b)}):void 0})},a.$watch("armedState.triggeredItems",function(){null!=a.armedState&&0==Object.keys(a.armedState.triggeredItems).length&&a.$dismiss()})}]);